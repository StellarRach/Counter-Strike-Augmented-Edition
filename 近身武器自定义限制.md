**此文档适用于 Build 3200 或更高版本。**

配置文件：

`platform\config\KnifeRestriction.yaml`

`platform\config\UserKnifeRestriction.yaml`

在编辑文件之前，请确保你对 YAML 文件有基本了解，没有的话可以先参考[这里](https://www.runoob.com/w3cnote/yaml-intro.html)。

# 文件结构
```
restricts:            # 按名称限制
  - stormgiant        # 例：限制【星陨】巨锤

extra:                # 高级配置
  - type: script      # 使用 Lua 脚本更改设定
    filename: path/to/script.lua      # 外置脚本文件的路径（相对于游戏根目录，或绝对路径）
  - type: script
    script: >
      if state.mapname == "de_dust" then    # 例：如果地图名为 de_dust 则限制 【弑神】双剑
          restrict( "dualsword" )
      end
  - type: external
    filename: path/to/another.yaml          # 嵌套读取的 YAML 配置文件（相对于游戏根目录，或绝对路径）
```

# 修改
**`platform\config\KnifeRestriction.yaml` 中的内容会在每次关闭 “模式选项” 界面时被覆盖。**

**要添加自定义内容，请修改 `platform\config\UserKnifeRestriction.yaml`。**

在服务器运行期间修改配置文件后，可以在控制台使用 `kres_reload` 命令将更改同步至游戏中。

更改将即时生效，但不会影响已经购买的近身武器。

这些限制仅适用于从购买菜单中购买，对于游戏中强制给予的近身武器（例如昼夜求生Ⅱ中通过操作台制造的近身武器）无效。

# 可限制的近身武器名称一览
| 配置名称 | 游戏内名称 |
| -------- | ---------- |
| skullaxe | 旋风SKULL-9 |
| nata | 背刺银刃 |
| knifedragon | 龙吻 |
| hammer | 风暴之锤 |
| dragonsword | 青龙偃月刀 |
| thanatos9 | 殒裂Thanatos-9 |
| stormgiant | 【星陨】巨锤 |
| janus9 | 灾厄Janus-9 |
| hdagger | 兽王铜匕 |
| jknife | 星芒蝶翼 |
| axe | 摄魂魔镰 |
| combatknife | 灭灵军刺 |
| mastercombatknife | 灭灵军刺•锯刃 |
| balrog9 | 爆裂Balrog-Ⅸ |
| balrog9b | 碎冰Balrog-9 |
| balrog9wc | 战勋爆裂Balrog-Ⅸ |
| dualsword | 【弑神】双剑 |
| holysword | 【辉煌】圣剑 |
| zsh_machete | 弯刀 |
| zsh_crowbar | 撬棍 |
| zsh_clawhammer | 钉锤 |

# 脚本参考
脚本使用 Lua 语言编写，请确保已有基础知识。

如 [文件结构](#文件结构) 中的示例所述，脚本有两种提供方式：外置文件、内嵌脚本，分别对应 `filename` 和 `script` 配置项。

如果 `filename` 是相对路径，则应该是相对于游戏根目录的。

脚本中所做的更改会影响 `restricts` 中指定的内容。例如你在 `restricts` 中指定了限制某一种近身武器，在脚本中又使用 `allow` 允许了同一种，最终结果将是不限制。

脚本中内置的游戏状态、CVAR 查询均为只读，不能更改。

## 脚本内置方法
| 名称 | 参数 | 说明 |
| ---- | ----- | ----- |
| `restrict` | 近身武器的配置名称 | 用于限制特定近身武器。也可以使用 `restrict("none")` 取消所有限制，或 `restrict("all")` 限制所有近身武器（默认小刀除外）。 |
| `allow` | 近身武器的配置名称 | 用于取消限制特定近身武器。也可以使用 `allow("none")` 限制所有近身武器（默认小刀除外），或 `allow("all")` 取消所有限制。 |
| `is_restricted` | 近身武器的配置名称 | 用于检测指定的近身武器是否已被限制 |

## 脚本内置对象
#### state
| 属性 | 说明 |
| ---- | ----- |
| `state.gamemode` | 当前的[游戏模式编号](https://github.com/StellarRach/Counter-Strike-Augmented-Edition/blob/master/CSAE%20%E6%B8%B8%E6%88%8F%E6%A8%A1%E5%BC%8F%E5%88%97%E8%A1%A8.md) |
| `state.mapname` | 当前的地图文件名（不含扩展名） |
| `state.weapon_restriction` | 当前的武器限制类型 |
| `state.enhance_restriction` | 当前的强化限制类型 |
| `state.is_zombie_mode` | 当前是否为生化模式 |

#### cvar
`cvar` 对象可以查询某一 CVAR 的当前值。

关于 CSAE 的控制台变量可以参考[这里](https://github.com/StellarRach/Counter-Strike-Augmented-Edition/blob/master/CSAE%20%E6%8E%A7%E5%88%B6%E5%8F%B0%E6%89%8B%E5%86%8C.md)。

例如 `cvar.mp_gamemode.value` 会返回 `mp_gamemode` 的值；`cvar.mp_gamemode.string` 会返回 `mp_gamemode` 的字符串值。

对于游戏模式、武器限制、强化限制，建议使用上述的 `state` 对应成员，返回的会是实际值而不是当前的 CVAR 值。

## 脚本示例
```lua
if state.mapname == "de_dust" then
    restrict( "dualsword" )
    allow( "thanatos9" )    -- 如果 "restricts" 配置中包含这里的近身武器名称，会重新允许使用
elseif state.gamemode == 15 then
    allow( "all" )          -- 或者调用 restrict( "none" ) 来取消目前的所有限制
    -- 可选: restrict( "example" )   -- 在取消所有后再单独限制某一种近身武器
elseif cvar.mp_startmoney.value == 800 then
    allow( "none" )         -- 或者调用 restrict( "all" ) 来限制默认小刀以外的所有近身武器
end
```
